#!/usr/bin/env bash
#
# tdd-start - Launch TDD Supervisor
#
# Usage:
#   tdd-start [OPTIONS]
#
# Options:
#   -d, --dir PATH      Project working directory (default: current)
#   -t, --task TEXT     Initial task description
#   -i, --id ID         Workflow ID (for resuming)
#   -h, --help          Show help
#
# Examples:
#   tdd-start
#   tdd-start -d ./my-project
#   tdd-start -t "Build a REST API for users"
#

set -e

# Find the tdd_supervisor module location
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Check if running from installed location (~/.claude/tdd-workflow/bin)
# or from repo location (repo/bin)
if [[ -d "$SCRIPT_DIR/../tdd_supervisor" ]]; then
    # Installed location: ~/.claude/tdd-workflow/bin/../tdd_supervisor
    SUPERVISOR_DIR="$(dirname "$SCRIPT_DIR")"
elif [[ -d "$(dirname "$SCRIPT_DIR")/tdd_supervisor" ]]; then
    # Repo location: repo/bin/../tdd_supervisor
    SUPERVISOR_DIR="$(dirname "$SCRIPT_DIR")"
else
    echo "Error: Cannot find tdd_supervisor module."
    echo "Expected at: $SCRIPT_DIR/../tdd_supervisor"
    exit 1
fi

# Add to PYTHONPATH so tdd_supervisor module can be found
export PYTHONPATH="${SUPERVISOR_DIR}:${PYTHONPATH:-}"

# Check if claude-agent-sdk is installed
if ! python3 -c "import claude_agent_sdk" 2>/dev/null; then
    echo "Error: claude-agent-sdk not installed."
    echo ""
    echo "Install with:"
    echo "  pip install claude-agent-sdk"
    echo ""
    echo "Or if using a virtual environment:"
    echo "  source your-venv/bin/activate"
    echo "  pip install claude-agent-sdk"
    exit 1
fi

# Run the supervisor module
exec python3 -m tdd_supervisor "$@"
